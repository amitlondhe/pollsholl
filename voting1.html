<!DOCTYPE html>
<html lang="en">
<head>
  <title>Select your favorite Lightning Talks</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<style>
		#sortable { list-style-type: none; margin: 0; padding: 0; width: 80%; }
		#sortable li { margin: 0 10px 10px 10px; padding: 1em; padding-left: 1.5em; font-size: 1.4em; height: auto; }

		.bg-1 { 
		   background-color:  #2b2b2f;; /* black */
		   color: #ffffff;
		}

		.bg-2 { 
		   background-color: #7a7784; /* grey */
		   color: #ffffff;
		}	
		
		.radius {
			border-radius:20%;
		}
		
		li { border-radius:1em; }
	</style>  
  
	<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyC7DqgTW-C7GrjRsGjd-D6jN4k_-h6MTCA",
		authDomain: "voting-a1fe7.firebaseapp.com",
		databaseURL: "https://voting-a1fe7.firebaseio.com",
		projectId: "voting-a1fe7",
		storageBucket: "",
		messagingSenderId: "805283765249"
	  };
	  firebase.initializeApp(config);
	</script>  
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  
  <!--
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
   -->
   
  <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="js/jquery.ui.touch-punch.min.js"></script>

  <script>
 
  $(document).ready(function() { 
  
	var entryHtml = '<li class="ui-state-default" style="background-color:#af23a4;color:white" id="#id">' + 
					'<div class="media">' +  
						'<div class="media-left">' + 
							'<img src="https://www.w3schools.com/bootstrap/img_chania.jpg" class="media-object img-circle" style="border-radius:20%;height:20% " >' +
						'</div>' + 
						'<div class="media-body">' +
							'<div>Name  : #speaker</div>' +
							'<div>' + 
								'<h4 class="media-heading">Topic : #topic</h4>' +
								'<p>#abstract</p>' + 
							'</div>' + 		    						
						'</div>' + 
					'</div>' +				
				'</li>';
  
  
	readEntries();
	
	var userid = "";
	$('#sortable').sortable({
	   scroll: true, 
	   scrollSensitivity: 100 ,
	   scrollSpeed: 50,
	   placeholder: "ui-state-highlight",
		//update: function () { save_new_order() }
	});

    $("#sortable" ).disableSelection();
	$("#entercode").hide();
	$("#sortable").hide();
	
	$("#getcode").click(function(){
		$("#entercode").show();
		$("#getcode").prop( "disabled", true );
	});
	$("#signinbutton").click(function(){
		$("#signin").hide();
		//$("#talks").show();
		$("#sortable").show();
	});
	
	/*
	$("#getcode").click(function(){
		alert("get Code");
		var phoneNumber = $("#phonenumber").val();
		phoneNumber = "+1"+phoneNumber;
		alert("Signing you in with "  + phoneNumber);
		onSignInSubmit(phoneNumber);		
	});
	
	$("#signinbutton").click(function(){
	    $("#signinbutton").prop( "disabled", true);
		var code = $("#passcode").val();
		alert( "code '" + code + "'");
		confirmationResult.confirm(code).then(function (result) {
		  // User signed in successfully.
		  var user = result.user;
		  userid = user.uid;
		  alert("Sign in Complete " + uid);
		  console.log("Sign in Complete and User Id is" + uid);
		  $("#signin").hide();
		  $("#talks").show();
		}).catch(function (error) {
		  // User couldn't sign in (bad verification code?)
		  // ...
		  $("#signin").show();
		  $("#entercode").hide();
		  $("#getcode").prop( "disabled", false );
		  $("#signinbutton").prop( "disabled", false);
		});	
	});
	*/
	
	function onSignInSubmit(phoneNumber) {
		firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
			.then(function (confirmationResult) {
			  // SMS sent. Prompt user to type the code from the message, then sign the
			  // user in with confirmationResult.confirm(code).
			  window.confirmationResult = confirmationResult;
			  alert("You should receive the code shortly.");
			  $("#entercode").show();
			  $("#getcode").prop( "disabled", true );
			}).catch(function (error) {
			  // Error; SMS not sent
			  console.log(error.message);
			  alert("Something went wrong" + error);
		});	
	}
	
	window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('getcode', {
		  'size': 'invisible'
	});	
	var appVerifier = window.recaptchaVerifier;	
	
	function save_new_order() {
		var a = [];
		
		alert("Top Selection " + $('#sortable').children().first().attr('id'));
		
		console.log("Top Selection " + $('#sortable').children().first().attr('id'));
		var toptalkid = $('#sortable').children().first().attr('id');
		// Get a reference to the database service
		var database = firebase.database();
		writeUserData(1,toptalkid);
	}
	
	
	/*
	Default security rule
	{
		"rules": {
			".read": "auth != null",
			".write": "auth != null"
		}
	}
	*/
	function writeUserData(userId, talkid) {
		firebase.database().ref('users/' + userId).set({
			toptalk: talkid
		});
	}
	
	function readEntries() {
		firebase.database().ref('/entries/').once('value').then(function(snapshot) {
		  /*var lightningTalks = snapshot.val();
		  console.log(lightningTalks);*/
		  snapshot.forEach(function(lightningTalk){
			var key = lightningTalk.key;
			console.log("Key ***" + key);
			// childData will be the actual contents of the child
			var childData = lightningTalk.val();
			console.log("Val ***" + childData);
			console.log("name:" + childData.name + ", topic:" + childData.topic + ", desc:"+childData.desc);

			var talkHtml = entryHtml;
			talkHtml = talkHtml.replace("#id",childData.name);
			talkHtml = talkHtml.replace("#speaker",childData.name);
			talkHtml = talkHtml.replace("#topic",childData.topic);
			talkHtml = talkHtml.replace("#abstract",childData.desc);
			$('#sortable').append(talkHtml);
		  });
		});	
	}
  });
  </script>
  
</head>
<body class="bg-2">

<div class="container-fluid bg-1 text-center ">
  <h1>Vote for Lightning Talk</h1>
  <p>{ Move the Talk you love to Top }</p> 
</div>
  
<div class="container-fluid bg-2">
   <div id="signin">
	<form>
	  <div id=enterphone">
		  <div class="form-group row">
			<div class="col-sm-6">
				<label for="phonenumber">Phone Number:</label>
				<input type="phone" class="form-control col-sm-5 " id="phonenumber" size="10" maxlength="10" >
			</div>
		  </div>
		  <button type="button" class="btn btn-primary" id="getcode">
		  Get Code</button>
	  </div>
	  
	  <div id="entercode" style="display:none">
		  <div class="form-group row">
			<div class="col-sm-6">
				<label for="passcode">Passcode:</label>
				<input type="text" class="form-control" id="passcode">
			</div>
		  </div>
		  <button type="button" class="btn btn-primary" id="signinbutton">Sign in</button>
	  </div>
	</form>
   </div>
  
	<ul id="sortable" class="list-group" style="margin:1em">				
	</ul>  
  
</div>



</body>
</html>
